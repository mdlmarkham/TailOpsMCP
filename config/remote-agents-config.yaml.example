# Remote Agent Configuration Example

This file demonstrates the comprehensive configuration for remote agent-like functionality
without requiring agent installation on target systems.

## Configuration

```yaml
# Remote Agent Configuration
# Location: /etc/systemmanager/remote-agents-config.yaml

# Global settings
remote_agents:
  enabled: true
  default_security_level: "medium"

  # Connection management
  connection_pool:
    max_connections: 50
    connection_timeout: 30
    idle_timeout: 300
    health_check_interval: 60
    max_connections_per_target: 10

  # SSH/Tailscale configuration
  ssh_config:
    port: 22
    username: "root"
    key_path: "~/.ssh/id_rsa"
    verify_host_key: true
    max_auth_attempts: 3
    connection_retry_delay: 5
    keepalive_interval: 30

  # Tailscale specific settings
  tailscale_config:
    enable_port_forwarding: true
    ssh_over_tailscale: true
    tailscale_hostname: null  # Will be auto-discovered
    tailscale_namespace: "default"
    timeout: 30

  # Retry and resilience configuration
  retry_policy:
    max_retries: 3
    backoff_multiplier: 2
    max_backoff: 30
    initial_delay: 1
    retry_on_connection_errors: true
    retry_on_timeout_errors: true

  # Security controls
  security:
    # Rate limiting (operations per time period)
    rate_limits:
      command_execution:
        max_per_hour: 100
        max_per_minute: 10
        max_per_second: 2
      file_access:
        max_per_hour: 50
        max_per_minute: 5
        max_per_second: 1
      service_control:
        max_per_hour: 20
        max_per_minute: 3
        max_per_second: 1
      container_control:
        max_per_hour: 30
        max_per_minute: 5
        max_per_second: 1

    # Security levels for different operations
    security_levels:
      observe_operations:
        - "get_journald_logs"
        - "get_service_status"
        - "list_remote_services"
        - "get_remote_docker_containers"
        - "get_container_logs_remote"
        - "read_remote_file"
        - "list_remote_directory"
        - "get_remote_system_status"
        level: "low"

      control_operations:
        - "restart_remote_service"
        - "restart_remote_container"
        - "write_remote_file"
        level: "medium"

      admin_operations:
        - "start_remote_service"
        - "stop_remote_service"
        - "start_remote_container"
        - "stop_remote_container"
        - "delete_remote_file"
        level: "high"

    # Access control scopes
    access_scopes:
      observe_only:
        description: "Read-only operations"
        operations: ["observe_operations"]

      limited_control:
        description: "Safe control operations"
        operations: ["observe_operations", "control_operations"]

      full_control:
        description: "All control operations"
        operations: ["observe_operations", "control_operations"]

      admin:
        description: "Administrative access"
        operations: ["observe_operations", "control_operations", "admin_operations"]

    # Blocked operations and paths
    blocked_commands:
      - "rm -rf"
      - "del /s"
      - "format"
      - "dd if="
      - "mkfs"
      - "fdisk"
      - "> /etc/passwd"
      - "> /etc/shadow"
      - "chmod 777"
      - "chown root"
      - "sudo -i"
      - "su -"
      - "exec"
      - "eval"

    blocked_paths:
      - "/etc/shadow"
      - "/etc/passwd"
      - "/etc/group"
      - "/etc/sudoers"
      - "/etc/ssh/ssh_host_"
      - "/root/"
      - "/.ssh/"
      - "/.aws/"
      - "/.docker/"
      - "/.kube/"
      - "/var/lib/dpkg/"
      - "/var/lib/apt/"
      - "/proc/"
      - "/sys/"
      - "/dev/"
      - "/run/systemd/"
      - "/boot/"

    allowed_file_extensions:
      - ".conf"
      - ".cfg"
      - ".ini"
      - ".yaml"
      - ".yml"
      - ".json"
      - ".txt"
      - ".log"
      - ".service"
      - ".socket"
      - ".target"
      - ".timer"
      - ".path"
      - ".mount"
      - ".env"
      - ".sh"
      - ".py"
      - ".pl"
      - ".rb"
      - ".js"
      - ".ts"
      - ".md"

    allowed_base_paths:
      - "/etc/systemd/system/"
      - "/etc/nginx/"
      - "/etc/ssl/"
      - "/etc/cron.d/"
      - "/etc/logrotate.d/"
      - "/var/log/"
      - "/var/log/journal/"
      - "/tmp/"
      - "/var/tmp/"
      - "/opt/"
      - "/usr/local/bin/"
      - "/home/"

  # Audit and logging configuration
  audit:
    enabled: true
    log_level: "INFO"
    audit_file: "./logs/remote_agents_audit.log"
    max_log_size: "100MB"
    backup_count: 5
    include_parameters: true
    include_results: false  # Set to true for detailed debugging
    include_performance_metrics: true
    sanitize_sensitive_data: true

    # Audit event types to log
    audit_events:
      - "connection_established"
      - "connection_failed"
      - "operation_executed"
      - "operation_failed"
      - "security_violation"
      - "access_denied"
      - "command_blocked"
      - "file_access"
      - "service_control"
      - "container_control"
      - "system_access"

  # Performance optimization
  performance:
    # Connection pooling settings
    connection_pooling:
      enabled: true
      max_idle_time: 300  # seconds
      min_connections: 2
      max_connections: 10

    # Caching settings
    caching:
      enabled: true
      cache_ttl: 300  # seconds
      max_cache_size: 1000  # entries
      cache_read_only_operations: true

    # Parallel execution
    parallel_execution:
      enabled: true
      max_concurrent_operations: 5
      timeout_per_operation: 30

  # Health monitoring
  health_monitoring:
    enabled: true
    check_interval: 60  # seconds
    failure_threshold: 3
    recovery_threshold: 2

    # Health check operations
    health_check_operations:
      - "connection_test"
      - "basic_command_test"
      - "service_access_test"
      - "docker_access_test"
      - "file_access_test"

  # Target-specific configurations
  targets:
    # Example target configurations
    "192.168.1.10":
      enabled: true
      connection_type: "ssh"
      host: "192.168.1.10"
      port: 22
      username: "root"
      key_path: "~/.ssh/id_rsa"
      timeout: 30
      allowed_operations:
        - "get_journald_logs"
        - "get_service_status"
        - "restart_remote_service"
        - "read_remote_file"
        - "write_remote_file"
      security_level: "medium"
      rate_limits:
        custom:
          command_execution:
            max_per_hour: 200

  # Fleet-wide operations
  fleet_operations:
    # Parallel execution settings
    parallel_targets:
      enabled: true
      max_concurrent_targets: 10
      batch_size: 5
      timeout_per_target: 60

    # Aggregation settings
    result_aggregation:
      enabled: true
      timeout: 300
      retry_failed_targets: true
      max_retries: 2

# Connector-specific configurations
connectors:
  # Journald connector
  journald:
    enabled: true
    default_lines: 100
    max_lines: 10000
    timeout: 60
    format: "json"  # json, short, verbose
    follow_timeout: 30

  # Service connector
  service:
    enabled: true
    default_timeout: 60
    systemctl_timeout: 30
    default_service_timeout: 120

  # Docker connector
  docker:
    enabled: true
    docker_host: "unix:///var/run/docker.sock"
    docker_port: 2376
    local_docker_port: 23760
    timeout: 30
    enable_port_forwarding: true

  # File connector
  file:
    enabled: true
    max_file_size: 10485760  # 10MB
    default_timeout: 60
    create_backups: true
    backup_location: "./backups/"
    secure_file_operations: true

# MCP Tools configuration
mcp_tools:
  enabled: true

  # Tool-specific settings
  tools:
    get_journald_logs:
      enabled: true
      max_lines: 1000
      default_timeout: 60

    restart_remote_service:
      enabled: true
      default_timeout: 60
      require_confirmation: false

    get_remote_docker_containers:
      enabled: true
      include_stopped: false
      default_timeout: 30

    read_remote_file:
      enabled: true
      max_file_size: 1048576  # 1MB
      require_confirmation_for_large_files: true

    write_remote_file:
      enabled: true
      create_backup: true
      require_confirmation: true
      backup_before_write: true

    analyze_service_logs_across_fleet:
      enabled: true
      max_targets: 50
      timeout: 300
      parallel_processing: true

    check_fleet_service_health:
      enabled: true
      max_targets: 100
      timeout: 180
      parallel_processing: true

# Integration settings
integration:
  # Policy system integration
  policy_system:
    enabled: true
    auto_register_capabilities: true
    capability_validation: true

  # Inventory system integration
  inventory_system:
    enabled: true
    auto_discover_targets: true
    update_interval: 300  # seconds

  # Observability integration
  observability:
    enabled: true
    metrics_collection: true
    performance_tracking: true
    health_metrics: true
    custom_metrics: true

# Development and testing settings
development:
  # Testing configuration
  testing:
    enabled: false
    mock_ssh_connections: false
    mock_target_responses: false
    test_data_directory: "./test_data/"

  # Debug settings
  debug:
    enabled: false
    log_level: "DEBUG"
    log_sql_queries: false
    log_api_calls: false
    profile_operations: false

  # Development targets
  dev_targets:
    - "localhost"
    - "127.0.0.1"

# Environment-specific overrides
environments:
  development:
    remote_agents:
      enabled: true
      security:
        security_level: "low"
        rate_limits:
          relaxed: true
      audit:
        log_level: "DEBUG"
        include_results: true

  production:
    remote_agents:
      enabled: true
      security:
        security_level: "high"
        rate_limits:
          strict: true
      audit:
        log_level: "INFO"
        include_results: false

  testing:
    remote_agents:
      enabled: true
      security:
        security_level: "low"
        blocked_commands: []
        blocked_paths: []
      testing:
        enabled: true
        mock_ssh_connections: true
```

## Usage Examples

### Basic Usage

```bash
# Enable remote agents
export SYSTEMMANAGER_REMOTE_AGENTS_ENABLED=true

# Set configuration file
export SYSTEMMANAGER_REMOTE_AGENTS_CONFIG="/etc/systemmanager/remote-agents-config.yaml"

# Start with remote agent support
python -m src.mcp_server
```

### Target Configuration

```yaml
# Add to targets section
targets:
  "web-server-01.example.com":
    enabled: true
    connection_type: "ssh"
    host: "web-server-01.example.com"
    port: 22
    username: "deploy"
    key_path: "~/.ssh/deploy_key"
    allowed_operations:
      - "get_journald_logs"
      - "restart_remote_service"
      - "read_remote_file"
```

### Security Configuration

```yaml
# Custom security policy
remote_agents:
  security:
    access_scopes:
      readonly_users:
        description: "Read-only access"
        operations: ["observe_operations"]
      operators:
        description: "Limited operator access"
        operations: ["observe_operations", "control_operations"]
      admins:
        description: "Full administrative access"
        operations: ["observe_operations", "control_operations", "admin_operations"]
```

## Integration Points

### With Fleet Inventory
- Automatic target discovery and registration
- Connection health monitoring
- Target availability tracking

### With Policy System
- Capability registration and validation
- Role-based access control
- Operation tier enforcement

### With Observability
- Performance metrics collection
- Health monitoring
- Audit trail integration
