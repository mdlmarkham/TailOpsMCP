#!/usr/bin/env bash\n# TailOpsMCP Universal Installer Dispatcher\n# Automatically detects platform and runs appropriate installer\n# Copyright (c) 2024 TailOpsMCP Contributors\n# License: MIT\n\nset -euo pipefail\n\n#######################################\n# Configuration\n#######################################\n\nVERSION="2.0.0"\n\n# Detect script directory\nSCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"\n\n#######################################\n# Quick Platform Detection\n#######################################\n\nfunction quick_detect_platform() {\n    local platform="standalone"\n\n    # Detect virtualization\n    local virt="none"\n    if command -v systemd-detect-virt &>/dev/null; then\n        virt=$(systemd-detect-virt 2>/dev/null || echo "none")\n    fi\n\n    # Check for cloud providers\n    if [ -f /sys/hypervisor/uuid ] && grep -qi ec2 /sys/hypervisor/uuid 2>/dev/null; then\n        platform="ec2"\n    elif curl -sf -m 1 http://169.254.169.254/latest/meta-data/instance-id &>/dev/null; then\n        platform="ec2"\n    elif curl -sf -H "Metadata-Flavor: Google" -m 1 http://metadata.google.internal/computeMetadata/v1/instance/id &>/dev/null; then\n        platform="ec2"  # Use same installer for all clouds\n    elif curl -sf -H "Metadata:true" -m 1 "http://169.254.169.254/metadata/instance?api-version=2021-02-01" &>/dev/null; then\n        platform="ec2"  # Use same installer for all clouds\n    elif [ "$virt" = "lxc" ]; then\n        platform="proxmox"\n    fi\n\n    echo "$platform"\n}\n\n#######################################\n# Display Help\n#######################################\n\nfunction show_help() {\n    cat << EOF\nTailOpsMCP Universal Installer v${VERSION}\n\nAutomatically detects your environment and runs the optimized installer.\n\nUSAGE:\n    sudo bash $0 [OPTIONS]\n\nOPTIONS:\n    --help              Show this help message\n    --platform TYPE     Force specific platform installer\n                        (standalone, proxmox, ec2)\n    --version           Show version information\n    --check             Check system and show what would be installed\n\n    All other options are passed to the platform-specific installer.\n    See platform installer help for details:\n      • Standalone: --help\n      • ProxMox:    scripts/install/install-proxmox.sh --help\n      • EC2/Cloud:  scripts/install/install-ec2.sh --help\n\nEXAMPLES:\n    # Automatic detection and installation\n    sudo bash $0\n\n    # Force ProxMox installer\n    sudo bash $0 --platform proxmox\n\n    # Non-interactive installation with token auth\n    sudo SYSTEMMANAGER_AUTH_MODE=token NON_INTERACTIVE=true bash $0\n\n    # Check what would be installed\n    sudo bash $0 --check\n\nENVIRONMENT VARIABLES:\n    SYSTEMMANAGER_INSTALL_DIR       Installation directory\n    SYSTEMMANAGER_PORT              Service port (default: 8080)\n    SYSTEMMANAGER_AUTH_MODE         Auth mode (oidc/token/none)\n    SYSTEMMANAGER_SHARED_SECRET     Token for token-based auth\n    NON_INTERACTIVE                 Set to 'true' for non-interactive mode\n    SKIP_DOCKER                     Set to 'true' to skip Docker\n    FORCE_REINSTALL                 Set to 'true' to force reinstall\n\nDOCUMENTATION:\n    https://github.com/mdlmarkham/TailOpsMCP\n\nEOF\n}\n\nfunction show_version() {\n    echo "TailOpsMCP Universal Installer v${VERSION}"\n    echo "Copyright (c) 2024 TailOpsMCP Contributors"\n    echo "License: MIT"\n}\n\n#######################################\n# System Check\n#######################################\n\nfunction check_system() {\n    echo "========================================"\n    echo " TailOpsMCP Installation Check"\n    echo "========================================"\n    echo ""\n\n    # Detect platform\n    local platform=$(quick_detect_platform)\n    echo "Detected Platform: $platform"\n\n    # Check OS\n    if [ -f /etc/os-release ]; then\n        . /etc/os-release\n        echo "Operating System: $PRETTY_NAME"\n    fi\n\n    # Check virtualization\n    if command -v systemd-detect-virt &>/dev/null; then\n        local virt=$(systemd-detect-virt 2>/dev/null || echo "none")\n        echo "Virtualization: $virt"\n    fi\n\n    # Check resources\n    echo ""\n    echo "System Resources:"\n    echo "  • Memory: $(free -h | awk '/^Mem:/{print $2}')"\n    echo "  • Disk: $(df -h / | awk 'NR==2{print $4}') available"\n    echo "  • CPU Cores: $(nproc 2>/dev/null || echo "unknown")"\n\n    # Check network\n    echo ""\n    echo "Network:"\n    echo "  • Hostname: $(hostname -f 2>/dev/null || hostname)"\n    echo "  • IP: $(hostname -I 2>/dev/null | awk '{print $1}')"\n\n    # Check Tailscale\n    echo ""\n    if command -v tailscale &>/dev/null; then\n        echo "Tailscale: Installed"\n        if tailscale status &>/dev/null 2>&1; then\n            echo "  Status: Running"\n            local ts_hostname=$(tailscale status --json 2>/dev/null | grep -oP '"DNSName":"\K[^"]+' | head -1 | sed 's/\.$//' || echo "")\n            if [ -n "$ts_hostname" ]; then\n                echo "  Hostname: $ts_hostname"\n            fi\n        else\n            echo "  Status: Not running"\n        fi\n    else\n        echo "Tailscale: Not installed"\n    fi\n\n    # Check Docker\n    echo ""\n    if command -v docker &>/dev/null; then\n        echo "Docker: Installed ($(docker --version 2>&1 | head -1))"\n    else\n        echo "Docker: Not installed (will be installed)"\n    fi\n\n    # Check Python\n    echo ""\n    for py_cmd in python3.12 python3.11 python3; do\n        if command -v "$py_cmd" &>/dev/null; then\n            echo "Python: $($py_cmd --version 2>&1)"\n            break\n        fi\n    done\n\n    echo ""\n    echo "========================================"\n    echo "Installer to use: install-${platform}.sh"\n    echo "========================================"\n    echo ""\n}\n\n#######################################\n# Main Dispatcher\n#######################################\n\nfunction main() {\n    local force_platform=""\n    local check_only=false\n    local installer_args=()\n\n    # Parse arguments\n    while [[ $# -gt 0 ]]; do\n        case $1 in\n            --help|-h)\n                show_help\n                exit 0\n                ;;\n            --version|-v)\n                show_version\n                exit 0\n                ;;\n            --check)\n                check_only=true\n                shift\n                ;;\n            --platform)\n                force_platform="$2"\n                shift 2\n                ;;\n            *)\n                # Pass through to installer\n                installer_args+=("$1")\n                shift\n                ;;\n        esac\n    done\n\n    # Check if running as root\n    if [ "$EUID" -ne 0 ]; then\n        echo "ERROR: This script must be run as root"\n        echo "Please run: sudo $0"\n        exit 1\n    fi\n\n    # If check only, show system info and exit\n    if [ "$check_only" = "true" ]; then\n        check_system\n        exit 0\n    fi\n\n    # Detect platform\n    local platform="$force_platform"\n    if [ -z "$platform" ]; then\n        platform=$(quick_detect_platform)\n        echo "Auto-detected platform: $platform"\n    else\n        echo "Using forced platform: $platform"\n    fi\n\n    # Validate platform\n    case "$platform" in\n        standalone|proxmox|ec2)\n            ;;\n        *)\n            echo "ERROR: Invalid platform: $platform"\n            echo "Valid platforms: standalone, proxmox, ec2"\n            exit 1\n            ;;\n    esac\n\n    # Select installer\n    local installer="$SCRIPT_DIR/install-${platform}.sh"\n\n    if [ ! -f "$installer" ]; then\n        echo "ERROR: Installer not found: $installer"\n        exit 1\n    fi\n\n    if [ ! -x "$installer" ]; then\n        chmod +x "$installer"\n    fi\n\n    # Run installer\n    echo "Running installer: $installer"\n    echo ""\n\n    exec bash "$installer" "${installer_args[@]}"\n}\n\n# Run main function\nmain "$@"\n
