#!/usr/bin/env bash\n# TailOpsMCP Standalone Installer\n# Works on any Linux system (LXC, EC2, bare metal, etc.)\n# Copyright (c) 2024 TailOpsMCP Contributors\n# License: MIT\n\nset -euo pipefail\n\n#######################################\n# Configuration\n#######################################\n\n# Installation defaults\nINSTALL_DIR="${SYSTEMMANAGER_INSTALL_DIR:-/opt/systemmanager}"\nSYSTEMMANAGER_PORT="${SYSTEMMANAGER_PORT:-8080}"\nDATA_DIR="${SYSTEMMANAGER_DATA_DIR:-/var/lib/systemmanager}"\n\n# Repository settings\nREPO_URL="${SYSTEMMANAGER_REPO_URL:-https://github.com/mdlmarkham/TailOpsMCP.git}"\nREPO_BRANCH="${SYSTEMMANAGER_REPO_BRANCH:-main}"\n\n# Installation options\nNON_INTERACTIVE="${NON_INTERACTIVE:-false}"\nSKIP_DOCKER="${SKIP_DOCKER:-false}"\nFORCE_REINSTALL="${FORCE_REINSTALL:-false}"\nCONFIG_FILE="${CONFIG_FILE:-}"\n\n# Mode flags\nUPGRADE_MODE=false\nREINSTALL_MODE=false\n\n# Standard output mode\nSTD="${STD:-}"\n\n#######################################\n# Detect Script Directory\n#######################################\n\nSCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"\nLIB_DIR="$SCRIPT_DIR/lib"\n\n#######################################\n# Load Library Modules\n#######################################\n\nfunction load_libraries() {\n    local libs=(\n        "$LIB_DIR/common.sh"\n        "$LIB_DIR/platform-detect.sh"\n        "$LIB_DIR/preflight.sh"\n        "$LIB_DIR/auth-setup.sh"\n        "$LIB_DIR/validation.sh"\n    )\n\n    for lib in "${libs[@]}"; do\n        if [ -f "$lib" ]; then\n            source "$lib"\n        else\n            echo "ERROR: Required library not found: $lib"\n            exit 1\n        fi\n    done\n}\n\n# Load all library modules\nload_libraries\n\n#######################################\n# Load Configuration File (if provided)\n#######################################\n\nfunction load_config_file() {\n    if [ -n "$CONFIG_FILE" ] && [ -f "$CONFIG_FILE" ]; then\n        msg_info "Loading configuration from: $CONFIG_FILE"\n        source "$CONFIG_FILE"\n        msg_ok "Configuration loaded"\n    fi\n}\n\n#######################################\n# Core Installation Steps\n#######################################\n\nfunction install_dependencies() {\n    msg_info "Installing dependencies"\n\n    install_base_packages\n    install_python\n\n    if [ "$SKIP_DOCKER" != "true" ]; then\n        install_docker\n    fi\n\n    msg_ok "Dependencies installed"\n}\n\nfunction setup_installation_directory() {\n    msg_info "Setting up installation directory"\n\n    # Clone or update repository\n    clone_repository "$INSTALL_DIR" "$REPO_URL" "$REPO_BRANCH"\n\n    track_step "files_created"\n    msg_ok "Installation directory setup complete"\n}\n\nfunction setup_python_environment() {\n    msg_info "Setting up Python environment"\n\n    setup_python_venv "$INSTALL_DIR"\n\n    msg_ok "Python environment ready"\n}\n\nfunction setup_service_user() {\n    msg_info "Setting up service user and permissions"\n\n    create_service_user\n    setup_permissions "$INSTALL_DIR" "$DATA_DIR"\n\n    msg_ok "Service user configured"\n}\n\nfunction setup_systemd_service() {\n    msg_info "Setting up systemd service"\n\n    create_systemd_service "$INSTALL_DIR" "$SYSTEMMANAGER_PORT" "$DATA_DIR"\n\n    msg_ok "Systemd service created"\n}\n\nfunction start_systemmanager_service() {\n    msg_info "Starting SystemManager service"\n\n    start_service\n\n    msg_ok "Service started"\n}\n\n#######################################\n# Upgrade Process\n#######################################\n\nfunction perform_upgrade() {\n    msg_info "Performing upgrade..."\n    print_separator\n\n    # Stop service\n    msg_info "Stopping service..."\n    systemctl stop systemmanager-mcp.service || true\n\n    # Backup configuration\n    backup_existing_config\n\n    # Update repository\n    msg_info "Updating repository..."\n    cd "$INSTALL_DIR"\n    git fetch origin\n    git checkout "$REPO_BRANCH"\n    git pull origin "$REPO_BRANCH"\n\n    # Get new version\n    local new_version=$(git describe --tags --always 2>/dev/null || git rev-parse --short HEAD 2>/dev/null || echo "unknown")\n    save_version "$new_version"\n    msg_ok "Updated to version: $new_version"\n\n    # Update Python dependencies\n    msg_info "Updating Python dependencies..."\n    source venv/bin/activate\n    pip install --upgrade pip\n    pip install -r requirements.txt\n    deactivate\n\n    # Restore configuration (keep existing .env)\n    msg_info "Configuration preserved"\n\n    # Start service\n    msg_info "Starting service..."\n    systemctl start systemmanager-mcp.service\n\n    # Quick validation\n    run_quick_validation\n\n    msg_ok "Upgrade complete"\n    print_separator\n}\n\n#######################################\n# Main Installation Flow\n#######################################\n\nfunction main() {\n    # Initialize\n    print_banner\n    init_state\n    setup_error_handling\n\n    # Load configuration file if provided\n    load_config_file\n\n    # Platform detection\n    run_platform_detection\n\n    # Pre-flight checks\n    run_preflight_checks || exit 1\n\n    # Check for upgrade mode\n    if [ "$UPGRADE_MODE" = "true" ]; then\n        perform_upgrade\n        display_installation_summary "$SYSTEMMANAGER_PORT"\n        cleanup_state\n        exit 0\n    fi\n\n    # Fresh installation\n    print_separator\n    msg_info "Starting TailOpsMCP installation"\n    print_separator\n\n    # Install dependencies\n    install_dependencies\n\n    # Setup installation\n    setup_installation_directory\n    setup_python_environment\n    setup_service_user\n\n    # Configure authentication\n    configure_authentication || exit 1\n\n    # Setup and start service\n    setup_systemd_service\n    start_systemmanager_service\n\n    # Validate installation\n    print_separator\n    if run_post_install_validation; then\n        # Display success summary\n        display_installation_summary "$SYSTEMMANAGER_PORT"\n\n        cleanup_state\n        exit 0\n    else\n        msg_error "Installation validation failed"\n        msg_info "Check logs: journalctl -u systemmanager-mcp -n 100"\n        exit 1\n    fi\n}\n\n#######################################\n# Handle Script Arguments\n#######################################\n\nfunction show_usage() {\n    cat << EOF\nUsage: $0 [OPTIONS]\n\nTailOpsMCP Standalone Installer\n\nOPTIONS:\n    --help                  Show this help message\n    --non-interactive       Run without prompts (requires env vars)\n    --skip-docker          Skip Docker installation\n    --force-reinstall      Force reinstall over existing installation\n    --config FILE          Load configuration from file\n    --install-dir DIR      Installation directory (default: /opt/systemmanager)\n    --port PORT            Service port (default: 8080)\n    --auth-mode MODE       Authentication mode: oidc, token, none\n\nENVIRONMENT VARIABLES:\n    SYSTEMMANAGER_INSTALL_DIR       Installation directory\n    SYSTEMMANAGER_PORT              Service port\n    SYSTEMMANAGER_AUTH_MODE         Auth mode (oidc/token/none)\n    SYSTEMMANAGER_SHARED_SECRET     Token for token-based auth\n    TSIDP_URL                       Tailscale IdP URL for OIDC\n    TSIDP_CLIENT_ID                 OIDC client ID\n    TSIDP_CLIENT_SECRET             OIDC client secret\n    NON_INTERACTIVE                 Set to 'true' for non-interactive mode\n    SKIP_DOCKER                     Set to 'true' to skip Docker\n    FORCE_REINSTALL                 Set to 'true' to force reinstall\n\nEXAMPLES:\n    # Interactive installation\n    sudo bash $0\n\n    # Non-interactive with token auth\n    sudo SYSTEMMANAGER_AUTH_MODE=token NON_INTERACTIVE=true bash $0\n\n    # Custom installation directory\n    sudo bash $0 --install-dir /opt/custom\n\n    # With configuration file\n    sudo bash $0 --config /etc/systemmanager/install.conf\n\nEOF\n}\n\n# Parse arguments\nwhile [[ $# -gt 0 ]]; do\n    case $1 in\n        --help)\n            show_usage\n            exit 0\n            ;;\n        --non-interactive)\n            NON_INTERACTIVE=true\n            shift\n            ;;\n        --skip-docker)\n            SKIP_DOCKER=true\n            shift\n            ;;\n        --force-reinstall)\n            FORCE_REINSTALL=true\n            shift\n            ;;\n        --config)\n            CONFIG_FILE="$2"\n            shift 2\n            ;;\n        --install-dir)\n            INSTALL_DIR="$2"\n            shift 2\n            ;;\n        --port)\n            SYSTEMMANAGER_PORT="$2"\n            shift 2\n            ;;\n        --auth-mode)\n            SYSTEMMANAGER_AUTH_MODE="$2"\n            shift 2\n            ;;\n        *)\n            echo "Unknown option: $1"\n            show_usage\n            exit 1\n            ;;\n    esac\ndone\n\n# Export configuration\nexport INSTALL_DIR SYSTEMMANAGER_PORT DATA_DIR\nexport NON_INTERACTIVE SKIP_DOCKER FORCE_REINSTALL\nexport REPO_URL REPO_BRANCH\n\n# Run main installation\nmain "$@"\n
