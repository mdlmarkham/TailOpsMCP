#!/usr/bin/env bash\n# TailOpsMCP ProxMox LXC Installer\n# Optimized for ProxMox LXC containers\n# Copyright (c) 2024 TailOpsMCP Contributors\n# License: MIT\n\nset -euo pipefail\n\n#######################################\n# ProxMox LXC Optimizations\n#######################################\n\nfunction apply_proxmox_optimizations() {\n    if [ "$PLATFORM" != "lxc" ]; then\n        msg_info "Not running in LXC, skipping ProxMox optimizations"\n        return 0\n    fi\n\n    msg_info "Applying ProxMox LXC optimizations"\n\n    # Check if running in privileged mode\n    if [ -w /sys/fs/cgroup ]; then\n        msg_ok "Running in privileged LXC mode"\n    else\n        msg_warn "Running in unprivileged LXC mode"\n        msg_info "Some features may have limited functionality"\n    fi\n\n    # Optimize for container environment\n    if [ -f /etc/systemd/journald.conf ]; then\n        # Reduce journal disk usage in containers\n        if ! grep -q "^SystemMaxUse=50M" /etc/systemd/journald.conf; then\n            cat >> /etc/systemd/journald.conf << EOF\n\n# TailOpsMCP optimizations for LXC\nSystemMaxUse=50M\nMaxRetentionSec=1week\nEOF\n            systemctl restart systemd-journald || true\n            msg_ok "Optimized journald for container"\n        fi\n    fi\n\n    msg_ok "ProxMox optimizations applied"\n}\n\nfunction check_proxmox_features() {\n    if [ "$PLATFORM" != "lxc" ]; then\n        return 0\n    fi\n\n    msg_info "Checking ProxMox LXC features"\n\n    # Check for nesting (required for Docker)\n    if [ "$SKIP_DOCKER" != "true" ]; then\n        if [ ! -d /sys/fs/cgroup/systemd ]; then\n            msg_warn "Container nesting not detected"\n            msg_warn "Docker may not work properly"\n            echo ""\n            msg_info "To enable Docker in LXC, add to container config:"\n            msg_info "  features: nesting=1,keyctl=1"\n            msg_info "  lxc.apparmor.profile: unconfined"\n            echo ""\n\n            if [ "$NON_INTERACTIVE" != "true" ]; then\n                if ! confirm_action "Continue without Docker support?" "y"; then\n                    exit 1\n                fi\n                SKIP_DOCKER=true\n                export SKIP_DOCKER\n            fi\n        else\n            msg_ok "Container nesting enabled"\n        fi\n    fi\n\n    # Check for TUN device (required for Tailscale)\n    if [ ! -c /dev/net/tun ]; then\n        msg_warn "/dev/net/tun not available"\n        msg_warn "Tailscale may not work properly"\n        echo ""\n        msg_info "To enable Tailscale in LXC, add to container config:"\n        msg_info "  lxc.cgroup2.devices.allow: c 10:200 rwm"\n        msg_info "  lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file"\n        echo ""\n\n        if [ "$NON_INTERACTIVE" != "true" ]; then\n            if ! confirm_action "Continue without Tailscale support?" "y"; then\n                exit 1\n            fi\n        fi\n    else\n        msg_ok "TUN device available"\n    fi\n}\n\nfunction setup_proxmox_networking() {\n    if [ "$PLATFORM" != "lxc" ]; then\n        return 0\n    fi\n\n    msg_info "Configuring networking for LXC"\n\n    # Ensure DNS resolution works\n    if [ ! -f /etc/resolv.conf ] || [ ! -s /etc/resolv.conf ]; then\n        msg_warn "DNS configuration missing or empty"\n        echo "nameserver 1.1.1.1" > /etc/resolv.conf\n        echo "nameserver 8.8.8.8" >> /etc/resolv.conf\n        msg_ok "DNS configuration fixed"\n    fi\n\n    msg_ok "Networking configured"\n}\n\nfunction create_proxmox_motd() {\n    if [ "$PLATFORM" != "lxc" ]; then\n        return 0\n    fi\n\n    msg_info "Creating ProxMox MOTD"\n\n    # Create custom MOTD\n    cat > /etc/update-motd.d/99-systemmanager << 'EOF'\n#!/bin/bash\necho ""\necho "  ╭────────────────────────────────────────────────╮"\necho "  │     TailOpsMCP - ProxMox LXC Container         │"\necho "  ╰────────────────────────────────────────────────╯"\necho ""\necho "  Service: systemctl status systemmanager-mcp"\necho "  Logs:    journalctl -u systemmanager-mcp -f"\necho ""\nEOF\n\n    chmod +x /etc/update-motd.d/99-systemmanager\n\n    msg_ok "MOTD created"\n}\n\nfunction display_proxmox_notes() {\n    if [ "$PLATFORM" != "lxc" ]; then\n        return 0\n    fi\n\n    print_separator\n    echo -e "${BLUE}ProxMox LXC Notes:${NC}"\n    echo ""\n\n    if [ -n "$CONTAINER_ID" ]; then\n        echo "  • Container ID: $CONTAINER_ID"\n        echo ""\n        echo "  Update container from host:"\n        echo "    pct exec $CONTAINER_ID -- bash -c 'cd /opt/systemmanager && git pull'"\n        echo ""\n    fi\n\n    echo "  Recommended container configuration:"\n    echo "    cores: 2"\n    echo "    memory: 2048"\n    echo "    features: nesting=1,keyctl=1"\n    echo "    lxc.apparmor.profile: unconfined"\n    echo "    lxc.cgroup2.devices.allow: c 10:200 rwm  # For Tailscale"\n    echo ""\n    print_separator\n}\n\n#######################################\n# Main ProxMox Installation\n#######################################\n\n# Detect script directory\nSCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"\n\n# Source the standalone installer\nif [ -f "$SCRIPT_DIR/install-standalone.sh" ]; then\n    # Just source functions, don't run main\n    source "$SCRIPT_DIR/install-standalone.sh" --help >/dev/null 2>&1 || true\n\n    # Load libraries manually\n    load_libraries\n\n    # Run ProxMox-specific installation\n    print_banner\n    init_state\n    setup_error_handling\n\n    # Load config if provided\n    load_config_file\n\n    # Platform detection\n    run_platform_detection\n\n    # ProxMox-specific checks\n    check_proxmox_features\n\n    # Run pre-flight checks\n    run_preflight_checks || exit 1\n\n    # Check for upgrade mode\n    if [ "$UPGRADE_MODE" = "true" ]; then\n        perform_upgrade\n        display_installation_summary "$SYSTEMMANAGER_PORT"\n        display_proxmox_notes\n        cleanup_state\n        exit 0\n    fi\n\n    # Fresh installation\n    print_separator\n    msg_info "Starting TailOpsMCP installation (ProxMox LXC)"\n    print_separator\n\n    # Install dependencies\n    install_dependencies\n\n    # Setup installation\n    setup_installation_directory\n    setup_python_environment\n    setup_service_user\n\n    # ProxMox optimizations\n    apply_proxmox_optimizations\n    setup_proxmox_networking\n\n    # Configure authentication\n    configure_authentication || exit 1\n\n    # Setup and start service\n    setup_systemd_service\n    start_systemmanager_service\n\n    # Create MOTD\n    create_proxmox_motd\n\n    # Validate installation\n    print_separator\n    if run_post_install_validation; then\n        # Display success summary\n        display_installation_summary "$SYSTEMMANAGER_PORT"\n        display_proxmox_notes\n\n        cleanup_state\n        exit 0\n    else\n        msg_error "Installation validation failed"\n        msg_info "Check logs: journalctl -u systemmanager-mcp -n 100"\n        exit 1\n    fi\nelse\n    echo "ERROR: install-standalone.sh not found in $SCRIPT_DIR"\n    exit 1\nfi\n
