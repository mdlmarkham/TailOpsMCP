#!/usr/bin/env bash\n# Post-installation validation for TailOpsMCP\n# Copyright (c) 2024 TailOpsMCP Contributors\n# License: MIT\n\n#######################################\n# Service Validation\n#######################################\n\nfunction validate_service_status() {\n    msg_info "Validating service status..."\n\n    # Check if service exists\n    if ! systemctl list-unit-files | grep -q "systemmanager-mcp.service"; then\n        msg_error "Service file not found"\n        return 1\n    fi\n\n    # Check if service is enabled\n    if systemctl is-enabled --quiet systemmanager-mcp.service; then\n        msg_ok "Service is enabled"\n    else\n        msg_warn "Service is not enabled for auto-start"\n    fi\n\n    # Check if service is running\n    if systemctl is-active --quiet systemmanager-mcp.service; then\n        msg_ok "Service is running"\n    else\n        msg_error "Service is not running"\n        msg_info "Check logs: journalctl -u systemmanager-mcp -n 50"\n        return 1\n    fi\n\n    # Check service status details\n    local service_state=$(systemctl show systemmanager-mcp.service -p ActiveState --value)\n    local service_substate=$(systemctl show systemmanager-mcp.service -p SubState --value)\n\n    msg_info "Service state: $service_state ($service_substate)"\n\n    return 0\n}\n\nfunction validate_service_logs() {\n    msg_info "Checking service logs for errors..."\n\n    # Get last 20 lines of logs\n    local logs=$(journalctl -u systemmanager-mcp -n 20 --no-pager 2>/dev/null)\n\n    if echo "$logs" | grep -qi "error\|failed\|exception"; then\n        msg_warn "Potential errors found in logs:"\n        echo "$logs" | grep -i "error\|failed\|exception" | tail -5\n        msg_info "Full logs: journalctl -u systemmanager-mcp -n 100"\n        return 1\n    else\n        msg_ok "No obvious errors in recent logs"\n    fi\n\n    return 0\n}\n\n#######################################\n# Network Validation\n#######################################\n\nfunction validate_port_listening() {\n    local port="${1:-${SYSTEMMANAGER_PORT:-8080}}"\n\n    msg_info "Checking if service is listening on port $port..."\n\n    # Wait a bit for service to fully start\n    sleep 2\n\n    # Check with multiple tools\n    local listening=false\n\n    if command -v lsof &>/dev/null; then\n        if lsof -Pi ":$port" -sTCP:LISTEN -t >/dev/null 2>&1; then\n            listening=true\n        fi\n    elif command -v ss &>/dev/null; then\n        if ss -tlnp 2>/dev/null | grep -q ":$port "; then\n            listening=true\n        fi\n    elif command -v netstat &>/dev/null; then\n        if netstat -tlnp 2>/dev/null | grep -q ":$port "; then\n            listening=true\n        fi\n    fi\n\n    if [ "$listening" = "true" ]; then\n        msg_ok "Service is listening on port $port"\n        return 0\n    else\n        msg_error "Service is not listening on port $port"\n        return 1\n    fi\n}\n\nfunction validate_local_connectivity() {\n    local port="${1:-${SYSTEMMANAGER_PORT:-8080}}"\n    local url="http://localhost:$port"\n\n    msg_info "Testing local connectivity to $url..."\n\n    # Try to connect\n    if curl -sf --max-time 5 "$url" >/dev/null 2>&1; then\n        msg_ok "Service is responding"\n        return 0\n    else\n        msg_error "Service is not responding at $url"\n        return 1\n    fi\n}\n\nfunction validate_health_endpoint() {\n    local port="${1:-${SYSTEMMANAGER_PORT:-8080}}"\n    local health_url="http://localhost:$port/.well-known/oauth-protected-resource/mcp"\n\n    msg_info "Testing health endpoint..."\n\n    local response=$(curl -sf --max-time 5 "$health_url" 2>/dev/null)\n\n    if [ -n "$response" ]; then\n        msg_ok "Health endpoint is responding"\n        return 0\n    else\n        msg_warn "Health endpoint not responding (may require authentication)"\n        return 0  # Don't fail on this\n    fi\n}\n\n#######################################\n# File System Validation\n#######################################\n\nfunction validate_installation_files() {\n    local errors=0\n\n    msg_info "Validating installation files..."\n\n    # Check installation directory\n    if [ ! -d "$INSTALL_DIR" ]; then\n        msg_error "Installation directory not found: $INSTALL_DIR"\n        ((errors++))\n    else\n        msg_ok "Installation directory exists"\n    fi\n\n    # Check critical files\n    local critical_files=(\n        "$INSTALL_DIR/.env"\n        "$INSTALL_DIR/venv/bin/python"\n        "$INSTALL_DIR/venv/bin/pip"\n        "$INSTALL_DIR/.version"\n    )\n\n    for file in "${critical_files[@]}"; do\n        if [ -f "$file" ] || [ -L "$file" ]; then\n            msg_ok "Found: $file"\n        else\n            msg_error "Missing: $file"\n            ((errors++))\n        fi\n    done\n\n    # Check data directory\n    if [ ! -d "$DEFAULT_DATA_DIR" ]; then\n        msg_error "Data directory not found: $DEFAULT_DATA_DIR"\n        ((errors++))\n    else\n        msg_ok "Data directory exists"\n    fi\n\n    return $errors\n}\n\nfunction validate_permissions() {\n    msg_info "Validating file permissions..."\n\n    # Check .env permissions\n    if [ -f "$INSTALL_DIR/.env" ]; then\n        local env_perms=$(stat -c %a "$INSTALL_DIR/.env" 2>/dev/null || stat -f %OLp "$INSTALL_DIR/.env" 2>/dev/null)\n        if [ "$env_perms" = "600" ]; then\n            msg_ok ".env file has correct permissions (600)"\n        else\n            msg_warn ".env file permissions: $env_perms (should be 600)"\n        fi\n    fi\n\n    # Check ownership\n    if [ -d "$INSTALL_DIR" ]; then\n        local owner=$(stat -c %U "$INSTALL_DIR" 2>/dev/null || stat -f %Su "$INSTALL_DIR" 2>/dev/null)\n        if [ "$owner" = "systemmanager" ]; then\n            msg_ok "Installation directory owned by systemmanager"\n        else\n            msg_warn "Installation directory owned by: $owner"\n        fi\n    fi\n\n    return 0\n}\n\n#######################################\n# Python Environment Validation\n#######################################\n\nfunction validate_python_env() {\n    msg_info "Validating Python environment..."\n\n    # Check venv activation\n    if [ ! -f "$INSTALL_DIR/venv/bin/activate" ]; then\n        msg_error "Virtual environment activation script not found"\n        return 1\n    fi\n\n    # Check Python version\n    local python_version=$("$INSTALL_DIR/venv/bin/python" --version 2>&1 | awk '{print $2}')\n    local major=$(echo "$python_version" | cut -d. -f1)\n    local minor=$(echo "$python_version" | cut -d. -f2)\n\n    if [ "$major" -ge 3 ] && [ "$minor" -ge 11 ]; then\n        msg_ok "Python version: $python_version"\n    else\n        msg_error "Python version too old: $python_version (need 3.11+)"\n        return 1\n    fi\n\n    # Check critical Python packages\n    msg_info "Checking Python dependencies..."\n\n    local packages=("fastmcp" "uvicorn" "python-dotenv")\n    local missing=0\n\n    for pkg in "${packages[@]}"; do\n        if "$INSTALL_DIR/venv/bin/python" -c "import ${pkg//-/_}" 2>/dev/null; then\n            msg_ok "Package installed: $pkg"\n        else\n            msg_error "Package missing: $pkg"\n            ((missing++))\n        fi\n    done\n\n    if [ $missing -gt 0 ]; then\n        msg_error "$missing Python package(s) missing"\n        return 1\n    fi\n\n    msg_ok "Python environment validated"\n    return 0\n}\n\n#######################################\n# Authentication Validation\n#######################################\n\nfunction validate_authentication() {\n    msg_info "Validating authentication configuration..."\n\n    if [ ! -f "$INSTALL_DIR/.env" ]; then\n        msg_error "Configuration file not found"\n        return 1\n    fi\n\n    source "$INSTALL_DIR/.env"\n\n    case "$SYSTEMMANAGER_AUTH_MODE" in\n        oidc)\n            msg_info "Auth mode: OIDC/Tailscale"\n            if [ -n "$TSIDP_URL" ] && [ -n "$TSIDP_CLIENT_ID" ] && [ -n "$TSIDP_CLIENT_SECRET" ]; then\n                msg_ok "OIDC configuration present"\n            else\n                msg_error "Incomplete OIDC configuration"\n                return 1\n            fi\n            ;;\n        token)\n            msg_info "Auth mode: Token-based"\n            if [ -n "$SYSTEMMANAGER_SHARED_SECRET" ]; then\n                msg_ok "Token configuration present"\n            else\n                msg_error "Token not configured"\n                return 1\n            fi\n            ;;\n        none)\n            msg_warn "Auth mode: None (development only)"\n            ;;\n        *)\n            msg_error "Invalid auth mode: $SYSTEMMANAGER_AUTH_MODE"\n            return 1\n            ;;\n    esac\n\n    return 0\n}\n\n#######################################\n# Docker Validation\n#######################################\n\nfunction validate_docker() {\n    if [ "$SKIP_DOCKER" = "true" ]; then\n        msg_info "Docker validation skipped (SKIP_DOCKER=true)"\n        return 0\n    fi\n\n    msg_info "Validating Docker installation..."\n\n    if ! command -v docker &>/dev/null; then\n        msg_warn "Docker not installed (optional)"\n        return 0\n    fi\n\n    # Check Docker daemon\n    if ! docker info &>/dev/null; then\n        msg_error "Docker daemon not running"\n        return 1\n    fi\n\n    msg_ok "Docker is installed and running"\n\n    # Check if systemmanager user is in docker group\n    if id -nG systemmanager 2>/dev/null | grep -qw docker; then\n        msg_ok "systemmanager user is in docker group"\n    else\n        msg_warn "systemmanager user not in docker group"\n    fi\n\n    return 0\n}\n\n#######################################\n# Integration Tests\n#######################################\n\nfunction run_integration_test() {\n    local port="${1:-${SYSTEMMANAGER_PORT:-8080}}"\n\n    msg_info "Running integration test..."\n\n    # Simple health check\n    local response=$(curl -sf --max-time 10 "http://localhost:$port/" 2>/dev/null)\n\n    if [ $? -eq 0 ]; then\n        msg_ok "Integration test passed"\n        return 0\n    else\n        msg_warn "Integration test failed (may require authentication)"\n        return 0  # Don't fail validation\n    fi\n}\n\n#######################################\n# Main Validation Function\n#######################################\n\nfunction run_post_install_validation() {\n    local errors=0\n\n    msg_info "Running post-installation validation..."\n    print_separator\n\n    # File system checks\n    validate_installation_files || ((errors++))\n    validate_permissions\n\n    # Service checks\n    validate_service_status || ((errors++))\n    validate_service_logs\n\n    # Network checks\n    validate_port_listening || ((errors++))\n    validate_local_connectivity || ((errors++))\n    validate_health_endpoint\n\n    # Environment checks\n    validate_python_env || ((errors++))\n    validate_authentication || ((errors++))\n\n    # Optional checks\n    validate_docker\n\n    # Integration test\n    run_integration_test\n\n    print_separator\n\n    if [ $errors -gt 0 ]; then\n        msg_error "$errors validation check(s) failed"\n        msg_info "Installation may have issues"\n        return 1\n    else\n        msg_ok "All validation checks passed"\n        return 0\n    fi\n}\n\n#######################################\n# Quick Validation (for upgrades)\n#######################################\n\nfunction run_quick_validation() {\n    local errors=0\n\n    msg_info "Running quick validation..."\n\n    validate_service_status || ((errors++))\n    validate_port_listening || ((errors++))\n    validate_local_connectivity || ((errors++))\n\n    if [ $errors -gt 0 ]; then\n        msg_error "$errors check(s) failed"\n        return 1\n    else\n        msg_ok "Quick validation passed"\n        return 0\n    fi\n}\n\n#######################################\n# Display Installation Summary\n#######################################\n\nfunction display_installation_summary() {\n    local port="${1:-${SYSTEMMANAGER_PORT:-8080}}"\n\n    print_separator\n    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"\n    echo -e "${GREEN}  ✓ Installation Complete!${NC}"\n    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"\n    echo ""\n    echo -e "${BLUE}Installation Summary:${NC}"\n    echo "  • Location:   $INSTALL_DIR"\n    echo "  • Version:    $(get_installed_version)"\n    echo "  • Service:    systemmanager-mcp"\n    echo "  • Port:       $port"\n\n    if [ -f "$INSTALL_DIR/.env" ]; then\n        source "$INSTALL_DIR/.env"\n        echo "  • Auth Mode:  $SYSTEMMANAGER_AUTH_MODE"\n\n        if [ "$SYSTEMMANAGER_AUTH_MODE" = "oidc" ] && [ -n "$SYSTEMMANAGER_BASE_URL" ]; then\n            echo "  • Server URL: $SYSTEMMANAGER_BASE_URL"\n        fi\n    fi\n\n    echo ""\n    echo -e "${BLUE}Service Commands:${NC}"\n    echo "  • Status:     systemctl status systemmanager-mcp"\n    echo "  • Logs:       journalctl -u systemmanager-mcp -f"\n    echo "  • Restart:    systemctl restart systemmanager-mcp"\n    echo "  • Stop:       systemctl stop systemmanager-mcp"\n\n    echo ""\n    echo -e "${BLUE}Testing:${NC}"\n    echo "  • Local test: curl http://localhost:$port/.well-known/oauth-protected-resource/mcp"\n\n    if [ "$TAILSCALE_RUNNING" = "true" ] && [ -n "$TAILSCALE_HOSTNAME" ]; then\n        echo "  • Tailscale:  curl http://${TAILSCALE_HOSTNAME}:$port/.well-known/oauth-protected-resource/mcp"\n    fi\n\n    echo ""\n    echo -e "${BLUE}Configuration:${NC}"\n    echo "  • Config:     $INSTALL_DIR/.env"\n    echo "  • Data:       $DEFAULT_DATA_DIR"\n    echo "  • Logs:       journalctl -u systemmanager-mcp"\n\n    if [ "$SYSTEMMANAGER_AUTH_MODE" = "token" ] && [ -n "$SYSTEMMANAGER_SHARED_SECRET" ]; then\n        echo ""\n        echo -e "${YELLOW}⚠️  Token Authentication:${NC}"\n        echo "  • Token: $SYSTEMMANAGER_SHARED_SECRET"\n        echo "  • Save this token securely!"\n    fi\n\n    if [ "$SYSTEMMANAGER_AUTH_MODE" = "oidc" ]; then\n        echo ""\n        echo -e "${BLUE}MCP Client Configuration:${NC}"\n        echo "  • URL: ${SYSTEMMANAGER_BASE_URL:-http://$HOSTNAME:$port}/mcp"\n        echo "  • Use OAuth authentication in your MCP client"\n    fi\n\n    echo ""\n    echo -e "${BLUE}Documentation:${NC}"\n    echo "  • GitHub: https://github.com/mdlmarkham/TailOpsMCP"\n    echo "  • Issues: https://github.com/mdlmarkham/TailOpsMCP/issues"\n\n    print_separator\n    echo ""\n}\n\n# Export functions\nexport -f validate_service_status validate_service_logs\nexport -f validate_port_listening validate_local_connectivity validate_health_endpoint\nexport -f validate_installation_files validate_permissions\nexport -f validate_python_env validate_authentication validate_docker\nexport -f run_integration_test\nexport -f run_post_install_validation run_quick_validation\nexport -f display_installation_summary\n
