#!/usr/bin/env bash\n# Authentication setup for TailOpsMCP installation\n# Copyright (c) 2024 TailOpsMCP Contributors\n# License: MIT\n\n#######################################\n# OIDC / Tailscale OAuth Setup\n#######################################\n\nfunction setup_oidc_auth() {\n    msg_info "Setting up Tailscale OAuth (TSIDP) authentication"\n\n    # Check if Tailscale is installed\n    if ! command -v tailscale &>/dev/null; then\n        msg_error "Tailscale not detected"\n        echo ""\n        msg_info "To install Tailscale:"\n        msg_info "  curl -fsSL https://tailscale.com/install.sh | sh"\n        echo ""\n\n        if confirm_action "Install Tailscale now?" "y"; then\n            install_tailscale || return 1\n        else\n            msg_error "Tailscale is required for OIDC authentication"\n            return 1\n        fi\n    fi\n\n    # Check if Tailscale is running\n    if ! tailscale status &>/dev/null 2>&1; then\n        msg_error "Tailscale is not running"\n        msg_info "Start Tailscale and authenticate:"\n        msg_info "  sudo tailscale up"\n        return 1\n    fi\n\n    msg_ok "Tailscale is installed and running"\n\n    # Display OAuth setup instructions\n    print_separator\n    echo -e "${YELLOW}Tailscale OAuth Setup Instructions:${NC}"\n    echo ""\n    echo "1. Open: https://login.tailscale.com/admin/oauth"\n    echo "2. Go to Settings → OAuth → Identity Provider"\n    echo "3. Click 'Enable' if not already enabled"\n    echo "4. Create a new OAuth application:"\n    echo "   • Name: TailOpsMCP"\n    echo "   • Redirect URI: https://vscode.dev/redirect"\n    echo "   • Scopes: openid, email, profile"\n    echo "5. Copy the Client ID and Client Secret"\n    print_separator\n    echo ""\n\n    # Get OAuth credentials\n    if [ -z "$TSIDP_URL" ]; then\n        read -p "TSIDP URL (e.g., https://tsidp.tail12345.ts.net): " TSIDP_URL\n    fi\n\n    if [ -z "$TSIDP_CLIENT_ID" ]; then\n        read -p "Client ID: " TSIDP_CLIENT_ID\n    fi\n\n    if [ -z "$TSIDP_CLIENT_SECRET" ]; then\n        read -sp "Client Secret (hidden): " TSIDP_CLIENT_SECRET\n        echo ""\n    fi\n\n    # Validate inputs\n    if [ -z "$TSIDP_URL" ] || [ -z "$TSIDP_CLIENT_ID" ] || [ -z "$TSIDP_CLIENT_SECRET" ]; then\n        msg_error "Missing required OAuth credentials"\n        return 1\n    fi\n\n    # Auto-detect Tailscale hostname\n    if [ -z "$SYSTEMMANAGER_BASE_URL" ]; then\n        if [ "$TAILSCALE_RUNNING" = "true" ] && [ -n "$TAILSCALE_HOSTNAME" ]; then\n            SYSTEMMANAGER_BASE_URL="http://${TAILSCALE_HOSTNAME}:${SYSTEMMANAGER_PORT:-8080}"\n            msg_ok "Auto-detected server URL: $SYSTEMMANAGER_BASE_URL"\n        else\n            read -p "Server Base URL (e.g., http://server.tail12345.ts.net:8080): " SYSTEMMANAGER_BASE_URL\n        fi\n    fi\n\n    # Create .env file\n    cat > "$INSTALL_DIR/.env" << EOF\n# TailOpsMCP Configuration\n# Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)\n\n# Authentication Mode\nSYSTEMMANAGER_AUTH_MODE=oidc\nSYSTEMMANAGER_REQUIRE_AUTH=true\n\n# Tailscale OAuth (TSIDP)\nTSIDP_URL=$TSIDP_URL\nTSIDP_CLIENT_ID=$TSIDP_CLIENT_ID\nTSIDP_CLIENT_SECRET=$TSIDP_CLIENT_SECRET\nSYSTEMMANAGER_BASE_URL=$SYSTEMMANAGER_BASE_URL\n\n# Logging\nLOG_LEVEL=INFO\nEOF\n\n    chmod 600 "$INSTALL_DIR/.env"\n    chown systemmanager:systemmanager "$INSTALL_DIR/.env" 2>/dev/null || true\n\n    msg_ok "OIDC authentication configured"\n    AUTH_MODE="oidc"\n    export AUTH_MODE\n}\n\n#######################################\n# Token-Based Authentication Setup\n#######################################\n\nfunction setup_token_auth() {\n    msg_info "Setting up token-based authentication"\n\n    # Generate or use provided token\n    if [ -z "$SYSTEMMANAGER_SHARED_SECRET" ]; then\n        msg_info "Generating secure token..."\n        SYSTEMMANAGER_SHARED_SECRET=$(openssl rand -hex 32)\n\n        echo ""\n        print_separator\n        echo -e "${GREEN}IMPORTANT: Save this token securely!${NC}"\n        echo ""\n        echo -e "  ${BLUE}$SYSTEMMANAGER_SHARED_SECRET${NC}"\n        echo ""\n        print_separator\n        echo ""\n\n        if [ "$NON_INTERACTIVE" != "true" ]; then\n            read -p "Press Enter to continue..."\n        fi\n    else\n        msg_info "Using provided token"\n    fi\n\n    # Create .env file\n    cat > "$INSTALL_DIR/.env" << EOF\n# TailOpsMCP Configuration\n# Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)\n\n# Authentication Mode\nSYSTEMMANAGER_AUTH_MODE=token\nSYSTEMMANAGER_REQUIRE_AUTH=true\n\n# Shared Secret Token\nSYSTEMMANAGER_SHARED_SECRET=$SYSTEMMANAGER_SHARED_SECRET\n\n# Logging\nLOG_LEVEL=INFO\nEOF\n\n    chmod 600 "$INSTALL_DIR/.env"\n    chown systemmanager:systemmanager "$INSTALL_DIR/.env" 2>/dev/null || true\n\n    msg_ok "Token authentication configured"\n    AUTH_MODE="token"\n    export AUTH_MODE SYSTEMMANAGER_SHARED_SECRET\n}\n\n#######################################\n# No Authentication (Development Only)\n#######################################\n\nfunction setup_no_auth() {\n    msg_warn "⚠️  WARNING: Configuring without authentication!"\n    msg_warn "This should ONLY be used in development environments"\n    msg_warn "Never expose this server to the internet without authentication"\n\n    if [ "$NON_INTERACTIVE" != "true" ]; then\n        echo ""\n        if ! confirm_action "Continue without authentication?" "N"; then\n            msg_error "Authentication setup cancelled"\n            return 1\n        fi\n    fi\n\n    # Create .env file\n    cat > "$INSTALL_DIR/.env" << EOF\n# TailOpsMCP Configuration\n# Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)\n\n# Authentication Mode - DEVELOPMENT ONLY\nSYSTEMMANAGER_AUTH_MODE=none\nSYSTEMMANAGER_REQUIRE_AUTH=false\n\n# Logging\nLOG_LEVEL=DEBUG\nEOF\n\n    chmod 600 "$INSTALL_DIR/.env"\n    chown systemmanager:systemmanager "$INSTALL_DIR/.env" 2>/dev/null || true\n\n    msg_ok "No authentication configured (DEVELOPMENT MODE)"\n    AUTH_MODE="none"\n    export AUTH_MODE\n}\n\n#######################################\n# Tailscale Installation Helper\n#######################################\n\nfunction install_tailscale() {\n    msg_info "Installing Tailscale..."\n\n    # Download Tailscale installer\n    local ts_script="/tmp/tailscale-install-$$.sh"\n    curl -fsSL https://tailscale.com/install.sh -o "$ts_script"\n\n    if [ ! -f "$ts_script" ]; then\n        msg_error "Failed to download Tailscale installer"\n        return 1\n    fi\n\n    # Run installer\n    $STD bash "$ts_script"\n    rm "$ts_script"\n\n    if command -v tailscale &>/dev/null; then\n        msg_ok "Tailscale installed successfully"\n\n        # Prompt to start Tailscale\n        msg_info "Starting Tailscale..."\n        msg_info "You may be prompted to authenticate"\n        echo ""\n\n        if tailscale up; then\n            msg_ok "Tailscale is running"\n            TAILSCALE_INSTALLED=true\n            TAILSCALE_RUNNING=true\n            detect_tailscale  # Re-detect to get hostname\n            return 0\n        else\n            msg_error "Failed to start Tailscale"\n            return 1\n        fi\n    else\n        msg_error "Tailscale installation failed"\n        return 1\n    fi\n}\n\n#######################################\n# Main Authentication Configuration\n#######################################\n\nfunction configure_authentication() {\n    msg_info "Configuring Authentication"\n    print_separator\n\n    # Check if already configured during upgrade\n    if [ "$UPGRADE_MODE" = "true" ] && [ -f "$INSTALL_DIR/.env" ]; then\n        msg_ok "Authentication already configured (upgrade mode)"\n\n        # Load existing auth mode\n        if grep -q "SYSTEMMANAGER_AUTH_MODE=oidc" "$INSTALL_DIR/.env"; then\n            AUTH_MODE="oidc"\n        elif grep -q "SYSTEMMANAGER_AUTH_MODE=token" "$INSTALL_DIR/.env"; then\n            AUTH_MODE="token"\n        else\n            AUTH_MODE="none"\n        fi\n\n        export AUTH_MODE\n        msg_info "Existing auth mode: $AUTH_MODE"\n\n        if [ "$NON_INTERACTIVE" != "true" ]; then\n            if ! confirm_action "Keep existing authentication?" "y"; then\n                backup_existing_config\n            else\n                return 0\n            fi\n        else\n            return 0\n        fi\n    fi\n\n    # Determine authentication mode\n    if [ -z "$SYSTEMMANAGER_AUTH_MODE" ]; then\n        if [ "$NON_INTERACTIVE" = "true" ]; then\n            msg_error "NON_INTERACTIVE=true requires SYSTEMMANAGER_AUTH_MODE to be set"\n            msg_info "Set one of: oidc, token, none"\n            return 1\n        fi\n\n        echo ""\n        echo -e "${YELLOW}Choose Authentication Method:${NC}"\n        echo "  1) Tailscale OAuth (TSIDP) - Recommended for multi-user"\n        echo "  2) Token-based - Simple shared secret"\n        echo "  3) No authentication - Development only"\n        echo ""\n        read -p "Select [1-3]: " auth_choice\n\n        case $auth_choice in\n            1) SYSTEMMANAGER_AUTH_MODE="oidc" ;;\n            2) SYSTEMMANAGER_AUTH_MODE="token" ;;\n            3) SYSTEMMANAGER_AUTH_MODE="none" ;;\n            *)\n                msg_error "Invalid selection"\n                return 1\n                ;;\n        esac\n    fi\n\n    # Setup authentication based on mode\n    case "$SYSTEMMANAGER_AUTH_MODE" in\n        oidc)\n            setup_oidc_auth || return 1\n            ;;\n        token)\n            setup_token_auth || return 1\n            ;;\n        none)\n            setup_no_auth || return 1\n            ;;\n        *)\n            msg_error "Invalid authentication mode: $SYSTEMMANAGER_AUTH_MODE"\n            msg_info "Valid modes: oidc, token, none"\n            return 1\n            ;;\n    esac\n\n    print_separator\n    msg_ok "Authentication configuration complete"\n    track_step "auth_configured"\n\n    return 0\n}\n\n#######################################\n# Validate Authentication Configuration\n#######################################\n\nfunction validate_auth_config() {\n    if [ ! -f "$INSTALL_DIR/.env" ]; then\n        msg_error "Authentication configuration file not found"\n        return 1\n    fi\n\n    source "$INSTALL_DIR/.env"\n\n    case "$SYSTEMMANAGER_AUTH_MODE" in\n        oidc)\n            if [ -z "$TSIDP_URL" ] || [ -z "$TSIDP_CLIENT_ID" ] || [ -z "$TSIDP_CLIENT_SECRET" ]; then\n                msg_error "Incomplete OIDC configuration"\n                return 1\n            fi\n            msg_ok "OIDC configuration validated"\n            ;;\n        token)\n            if [ -z "$SYSTEMMANAGER_SHARED_SECRET" ]; then\n                msg_error "Token not configured"\n                return 1\n            fi\n            msg_ok "Token configuration validated"\n            ;;\n        none)\n            msg_ok "No authentication mode validated"\n            ;;\n        *)\n            msg_error "Invalid authentication mode: $SYSTEMMANAGER_AUTH_MODE"\n            return 1\n            ;;\n    esac\n\n    return 0\n}\n\n# Export functions\nexport -f setup_oidc_auth setup_token_auth setup_no_auth\nexport -f install_tailscale\nexport -f configure_authentication validate_auth_config\n
