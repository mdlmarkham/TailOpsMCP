#!/usr/bin/env bash\n# Platform detection for TailOpsMCP installation\n# Copyright (c) 2024 TailOpsMCP Contributors\n# License: MIT\n\n#######################################\n# Detect Virtualization Type\n#######################################\n\nfunction detect_virtualization() {\n    VIRT_TYPE="none"\n\n    # Try systemd-detect-virt first (most reliable)\n    if command -v systemd-detect-virt &>/dev/null; then\n        VIRT_TYPE=$(systemd-detect-virt 2>/dev/null || echo "none")\n    # Fallback to other detection methods\n    elif [ -f /proc/1/environ ]; then\n        if grep -qa container /proc/1/environ; then\n            VIRT_TYPE="container"\n        fi\n    fi\n\n    # Special case detection\n    if [ "$VIRT_TYPE" = "none" ] && [ -e /dev/lxd/sock ]; then\n        VIRT_TYPE="lxd"\n    fi\n\n    export VIRT_TYPE\n    msg_info "Virtualization type: $VIRT_TYPE"\n}\n\n#######################################\n# Detect Cloud Provider\n#######################################\n\nfunction detect_cloud_provider() {\n    CLOUD_PROVIDER="none"\n\n    # AWS EC2\n    if [ -f /sys/hypervisor/uuid ] && grep -qi ec2 /sys/hypervisor/uuid 2>/dev/null; then\n        CLOUD_PROVIDER="aws"\n    elif [ -f /sys/class/dmi/id/product_uuid ] && grep -qi ec2 /sys/class/dmi/id/product_uuid 2>/dev/null; then\n        CLOUD_PROVIDER="aws"\n    elif [ -f /sys/class/dmi/id/bios_vendor ] && grep -qi amazon /sys/class/dmi/id/bios_vendor 2>/dev/null; then\n        CLOUD_PROVIDER="aws"\n    # Check IMDSv2 endpoint (most reliable for EC2)\n    elif curl -s -m 1 http://169.254.169.254/latest/meta-data/instance-id &>/dev/null; then\n        CLOUD_PROVIDER="aws"\n\n    # Google Cloud Platform\n    elif curl -s -H "Metadata-Flavor: Google" -m 1 http://metadata.google.internal/computeMetadata/v1/instance/id &>/dev/null; then\n        CLOUD_PROVIDER="gcp"\n\n    # Microsoft Azure\n    elif curl -s -H "Metadata:true" -m 1 "http://169.254.169.254/metadata/instance?api-version=2021-02-01" &>/dev/null; then\n        CLOUD_PROVIDER="azure"\n\n    # DigitalOcean\n    elif curl -s -m 1 http://169.254.169.254/metadata/v1/id &>/dev/null; then\n        CLOUD_PROVIDER="digitalocean"\n\n    # Oracle Cloud\n    elif [ -f /sys/class/dmi/id/chassis_asset_tag ] && grep -qi oraclecloud /sys/class/dmi/id/chassis_asset_tag 2>/dev/null; then\n        CLOUD_PROVIDER="oracle"\n\n    # Hetzner Cloud\n    elif [ -f /sys/class/dmi/id/sys_vendor ] && grep -qi hetzner /sys/class/dmi/id/sys_vendor 2>/dev/null; then\n        CLOUD_PROVIDER="hetzner"\n    fi\n\n    export CLOUD_PROVIDER\n    if [ "$CLOUD_PROVIDER" != "none" ]; then\n        msg_info "Cloud provider: $CLOUD_PROVIDER"\n    fi\n}\n\n#######################################\n# Detect Platform Type\n#######################################\n\nfunction detect_platform() {\n    # Detect virtualization first\n    detect_virtualization\n\n    # Detect cloud provider\n    detect_cloud_provider\n\n    # Determine platform type\n    if [ "$CLOUD_PROVIDER" != "none" ]; then\n        PLATFORM="$CLOUD_PROVIDER"\n    elif [ "$VIRT_TYPE" = "lxc" ]; then\n        PLATFORM="lxc"\n    elif [ "$VIRT_TYPE" = "kvm" ]; then\n        PLATFORM="kvm"\n    elif [ "$VIRT_TYPE" = "docker" ]; then\n        PLATFORM="docker"\n    elif [ "$VIRT_TYPE" = "vmware" ]; then\n        PLATFORM="vmware"\n    elif [ "$VIRT_TYPE" = "xen" ]; then\n        PLATFORM="xen"\n    elif [ "$VIRT_TYPE" = "none" ]; then\n        PLATFORM="baremetal"\n    else\n        PLATFORM="$VIRT_TYPE"\n    fi\n\n    export PLATFORM\n    msg_ok "Platform detected: $PLATFORM"\n}\n\n#######################################\n# Detect Operating System\n#######################################\n\nfunction detect_os() {\n    if [ -f /etc/os-release ]; then\n        . /etc/os-release\n        OS_ID="$ID"\n        OS_VERSION="$VERSION_ID"\n        OS_NAME="$NAME"\n        OS_PRETTY_NAME="$PRETTY_NAME"\n    elif [ -f /etc/redhat-release ]; then\n        OS_NAME=$(cat /etc/redhat-release)\n        OS_ID="rhel"\n    elif [ -f /etc/debian_version ]; then\n        OS_NAME="Debian"\n        OS_ID="debian"\n        OS_VERSION=$(cat /etc/debian_version)\n    else\n        OS_NAME="Unknown"\n        OS_ID="unknown"\n        OS_VERSION="unknown"\n    fi\n\n    export OS_ID OS_VERSION OS_NAME OS_PRETTY_NAME\n    msg_info "Operating System: $OS_PRETTY_NAME"\n}\n\n#######################################\n# Check OS Compatibility\n#######################################\n\nfunction check_os_compatibility() {\n    local supported=0\n\n    case "$OS_ID" in\n        ubuntu)\n            # Ubuntu 20.04 and newer\n            if [ "${OS_VERSION%%.*}" -ge 20 ]; then\n                supported=1\n            fi\n            ;;\n        debian)\n            # Debian 11 and newer\n            if [ "${OS_VERSION%%.*}" -ge 11 ]; then\n                supported=1\n            fi\n            ;;\n        rhel|centos|rocky|almalinux)\n            # RHEL 8 and newer\n            if [ "${OS_VERSION%%.*}" -ge 8 ]; then\n                supported=1\n            fi\n            ;;\n        fedora)\n            # Fedora 35 and newer\n            if [ "${OS_VERSION%%.*}" -ge 35 ]; then\n                supported=1\n            fi\n            ;;\n        *)\n            msg_warn "Unsupported or untested OS: $OS_NAME"\n            ;;\n    esac\n\n    if [ $supported -eq 0 ]; then\n        msg_warn "This OS version may not be fully supported"\n        msg_warn "Supported: Ubuntu 20.04+, Debian 11+, RHEL/Rocky/Alma 8+, Fedora 35+"\n\n        if ! confirm_action "Continue with unsupported OS?" "N"; then\n            msg_error "Installation cancelled"\n            exit 1\n        fi\n    else\n        msg_ok "OS version supported"\n    fi\n}\n\n#######################################\n# Detect System Resources\n#######################################\n\nfunction detect_system_resources() {\n    # Memory (in MB)\n    TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')\n\n    # Disk space (in GB)\n    AVAIL_DISK=$(df -BG /opt 2>/dev/null | tail -1 | awk '{print $4}' | sed 's/G//' || echo "0")\n    if [ "$AVAIL_DISK" = "0" ]; then\n        AVAIL_DISK=$(df -BG / 2>/dev/null | tail -1 | awk '{print $4}' | sed 's/G//' || echo "0")\n    fi\n\n    # CPU cores\n    CPU_CORES=$(nproc 2>/dev/null || grep -c ^processor /proc/cpuinfo 2>/dev/null || echo "1")\n\n    export TOTAL_MEM AVAIL_DISK CPU_CORES\n\n    msg_info "System resources:"\n    msg_info "  Memory: ${TOTAL_MEM}MB"\n    msg_info "  Available disk: ${AVAIL_DISK}GB"\n    msg_info "  CPU cores: $CPU_CORES"\n}\n\n#######################################\n# Platform-Specific Checks\n#######################################\n\nfunction check_lxc_features() {\n    if [ "$PLATFORM" = "lxc" ]; then\n        msg_info "Checking LXC container features..."\n\n        # Check for Docker support (nesting)\n        if [ -f /proc/self/status ]; then\n            if grep -q "^CapBnd:.*[^0]" /proc/self/status; then\n                msg_ok "Container has sufficient capabilities"\n            else\n                msg_warn "Container may have limited capabilities"\n                msg_warn "For Docker support, enable: features: nesting=1"\n            fi\n        fi\n\n        # Check if /dev/net/tun exists for Tailscale\n        if [ -c /dev/net/tun ]; then\n            msg_ok "TUN device available for Tailscale"\n        else\n            msg_warn "/dev/net/tun not available"\n            msg_warn "For Tailscale, add to LXC config: lxc.cgroup2.devices.allow: c 10:200 rwm"\n        fi\n    fi\n}\n\nfunction check_cloud_specific() {\n    case "$CLOUD_PROVIDER" in\n        aws)\n            msg_info "Detected AWS EC2 instance"\n            # Check IMDSv2\n            if curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" &>/dev/null; then\n                msg_ok "IMDSv2 is enabled"\n            else\n                msg_warn "IMDSv2 may not be enabled"\n            fi\n            ;;\n        gcp)\n            msg_info "Detected Google Cloud Platform instance"\n            ;;\n        azure)\n            msg_info "Detected Microsoft Azure instance"\n            ;;\n        digitalocean)\n            msg_info "Detected DigitalOcean Droplet"\n            ;;\n    esac\n}\n\n#######################################\n# Detect ProxMox Host Environment\n#######################################\n\nfunction is_proxmox_host() {\n    # Check if this is a ProxMox VE host\n    if [ -f /etc/pve/.version ] || command -v pveversion &>/dev/null; then\n        return 0\n    fi\n    return 1\n}\n\nfunction detect_proxmox_container_id() {\n    if [ "$PLATFORM" = "lxc" ] && [ -f /proc/1/cgroup ]; then\n        # Extract container ID from cgroup\n        CONTAINER_ID=$(grep -oP 'lxc/\K\d+' /proc/1/cgroup | head -1)\n        if [ -n "$CONTAINER_ID" ]; then\n            export CONTAINER_ID\n            msg_info "ProxMox LXC container ID: $CONTAINER_ID"\n        fi\n    fi\n}\n\n#######################################\n# Get Network Information\n#######################################\n\nfunction detect_network_info() {\n    # Get primary IP address\n    PRIMARY_IP=$(hostname -I 2>/dev/null | awk '{print $1}' || echo "unknown")\n\n    # Get hostname\n    HOSTNAME=$(hostname -f 2>/dev/null || hostname 2>/dev/null || echo "unknown")\n\n    export PRIMARY_IP HOSTNAME\n\n    msg_info "Network information:"\n    msg_info "  Hostname: $HOSTNAME"\n    msg_info "  Primary IP: $PRIMARY_IP"\n}\n\n#######################################\n# Detect Tailscale\n#######################################\n\nfunction detect_tailscale() {\n    TAILSCALE_INSTALLED=false\n    TAILSCALE_RUNNING=false\n    TAILSCALE_HOSTNAME=""\n\n    if command -v tailscale &>/dev/null; then\n        TAILSCALE_INSTALLED=true\n        msg_ok "Tailscale is installed"\n\n        if tailscale status &>/dev/null 2>&1; then\n            TAILSCALE_RUNNING=true\n            msg_ok "Tailscale is running"\n\n            # Get Tailscale hostname\n            TAILSCALE_HOSTNAME=$(tailscale status --json 2>/dev/null | grep -oP '"DNSName":"\K[^"]+' | head -1 | sed 's/\.$//' || echo "")\n            if [ -n "$TAILSCALE_HOSTNAME" ]; then\n                msg_info "Tailscale hostname: $TAILSCALE_HOSTNAME"\n            fi\n        else\n            msg_warn "Tailscale is installed but not running"\n        fi\n    else\n        msg_info "Tailscale not installed"\n    fi\n\n    export TAILSCALE_INSTALLED TAILSCALE_RUNNING TAILSCALE_HOSTNAME\n}\n\n#######################################\n# Main Detection Function\n#######################################\n\nfunction run_platform_detection() {\n    msg_info "Detecting system platform and configuration..."\n    print_separator\n\n    detect_os\n    check_os_compatibility\n    detect_platform\n    detect_system_resources\n    detect_network_info\n    detect_tailscale\n\n    # Platform-specific checks\n    check_lxc_features\n    check_cloud_specific\n\n    # ProxMox specific\n    if [ "$PLATFORM" = "lxc" ]; then\n        detect_proxmox_container_id\n    fi\n\n    print_separator\n    msg_ok "Platform detection complete"\n\n    # Export summary\n    export PLATFORM VIRT_TYPE CLOUD_PROVIDER\n    export OS_ID OS_VERSION OS_NAME\n    export TOTAL_MEM AVAIL_DISK CPU_CORES\n    export PRIMARY_IP HOSTNAME\n}\n\n# Export functions\nexport -f detect_virtualization detect_cloud_provider detect_platform\nexport -f detect_os check_os_compatibility\nexport -f detect_system_resources\nexport -f check_lxc_features check_cloud_specific\nexport -f is_proxmox_host detect_proxmox_container_id\nexport -f detect_network_info detect_tailscale\nexport -f run_platform_detection\n
