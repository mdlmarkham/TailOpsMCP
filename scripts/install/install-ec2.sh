#!/usr/bin/env bash\n# TailOpsMCP EC2/Cloud Installer\n# Optimized for cloud environments (AWS, GCP, Azure, etc.)\n# Copyright (c) 2024 TailOpsMCP Contributors\n# License: MIT\n\nset -euo pipefail\n\n#######################################\n# Cloud-Specific Optimizations\n#######################################\n\nfunction apply_cloud_optimizations() {\n    msg_info "Applying cloud environment optimizations"\n\n    case "$CLOUD_PROVIDER" in\n        aws)\n            apply_aws_optimizations\n            ;;\n        gcp)\n            apply_gcp_optimizations\n            ;;\n        azure)\n            apply_azure_optimizations\n            ;;\n        digitalocean)\n            apply_digitalocean_optimizations\n            ;;\n        *)\n            msg_info "No specific optimizations for: $CLOUD_PROVIDER"\n            ;;\n    esac\n\n    msg_ok "Cloud optimizations applied"\n}\n\nfunction apply_aws_optimizations() {\n    msg_info "Applying AWS EC2 optimizations"\n\n    # Install AWS CLI if not present (optional)\n    if ! command -v aws &>/dev/null; then\n        msg_info "AWS CLI not found (optional)"\n    fi\n\n    # Configure CloudWatch logs (optional, requires IAM permissions)\n    if [ "$NON_INTERACTIVE" != "true" ]; then\n        if confirm_action "Configure CloudWatch logs?" "N"; then\n            setup_cloudwatch_logs\n        fi\n    fi\n\n    # Optimize for EC2 metadata service\n    if [ -f /etc/systemd/system/systemmanager-mcp.service ]; then\n        # Ensure service waits for network\n        if ! grep -q "After=cloud-final.service" /etc/systemd/system/systemmanager-mcp.service; then\n            sed -i 's/After=network-online.target/After=network-online.target cloud-final.service/' \\n                /etc/systemd/system/systemmanager-mcp.service || true\n        fi\n    fi\n\n    msg_ok "AWS optimizations applied"\n}\n\nfunction apply_gcp_optimizations() {\n    msg_info "Applying GCP optimizations"\n\n    # Install gcloud SDK if not present (optional)\n    if ! command -v gcloud &>/dev/null; then\n        msg_info "gcloud SDK not found (optional)"\n    fi\n\n    msg_ok "GCP optimizations applied"\n}\n\nfunction apply_azure_optimizations() {\n    msg_info "Applying Azure optimizations"\n\n    # Install Azure CLI if not present (optional)\n    if ! command -v az &>/dev/null; then\n        msg_info "Azure CLI not found (optional)"\n    fi\n\n    msg_ok "Azure optimizations applied"\n}\n\nfunction apply_digitalocean_optimizations() {\n    msg_info "Applying DigitalOcean optimizations"\n\n    # Install doctl if not present (optional)\n    if ! command -v doctl &>/dev/null; then\n        msg_info "doctl not found (optional)"\n    fi\n\n    msg_ok "DigitalOcean optimizations applied"\n}\n\nfunction setup_cloudwatch_logs() {\n    msg_info "Setting up CloudWatch logs..."\n    msg_warn "This feature requires IAM permissions"\n    msg_info "Skipping CloudWatch setup (implement if needed)"\n}\n\n#######################################\n# Cloud Security Configuration\n#######################################\n\nfunction configure_cloud_security() {\n    msg_info "Configuring cloud security settings"\n\n    # Ensure firewall allows port\n    case "$OS_ID" in\n        ubuntu|debian)\n            if command -v ufw &>/dev/null; then\n                if ufw status | grep -q "Status: active"; then\n                    msg_info "UFW is active"\n                    if [ "$NON_INTERACTIVE" != "true" ]; then\n                        if confirm_action "Allow port $SYSTEMMANAGER_PORT through UFW?" "y"; then\n                            ufw allow "$SYSTEMMANAGER_PORT/tcp"\n                            msg_ok "Port $SYSTEMMANAGER_PORT allowed through UFW"\n                        fi\n                    fi\n                fi\n            fi\n            ;;\n        rhel|centos|rocky|almalinux|fedora)\n            if command -v firewall-cmd &>/dev/null; then\n                if firewall-cmd --state 2>/dev/null | grep -q "running"; then\n                    msg_info "firewalld is active"\n                    if [ "$NON_INTERACTIVE" != "true" ]; then\n                        if confirm_action "Allow port $SYSTEMMANAGER_PORT through firewalld?" "y"; then\n                            firewall-cmd --permanent --add-port="$SYSTEMMANAGER_PORT/tcp"\n                            firewall-cmd --reload\n                            msg_ok "Port $SYSTEMMANAGER_PORT allowed through firewalld"\n                        fi\n                    fi\n                fi\n            fi\n            ;;\n    esac\n\n    msg_ok "Cloud security configured"\n}\n\nfunction display_cloud_security_notes() {\n    print_separator\n    echo -e "${YELLOW}⚠️  Cloud Security Checklist:${NC}"\n    echo ""\n\n    case "$CLOUD_PROVIDER" in\n        aws)\n            echo "  AWS EC2 Security:"\n            echo "  • Update Security Group to allow port $SYSTEMMANAGER_PORT"\n            echo "  • Or use Tailscale for secure access (recommended)"\n            echo "  • Consider using AWS Systems Manager Session Manager"\n            echo ""\n            echo "  Security Group rule:"\n            echo "    Type: Custom TCP"\n            echo "    Port: $SYSTEMMANAGER_PORT"\n            echo "    Source: Your IP or 0.0.0.0/0 (if using Tailscale)"\n            ;;\n        gcp)\n            echo "  GCP Compute Engine Security:"\n            echo "  • Update firewall rules to allow port $SYSTEMMANAGER_PORT"\n            echo "  • Or use Tailscale for secure access (recommended)"\n            echo ""\n            echo "  Firewall rule:"\n            echo "    gcloud compute firewall-rules create allow-systemmanager \\"\n            echo "      --allow=tcp:$SYSTEMMANAGER_PORT \\"\n            echo "      --source-ranges=0.0.0.0/0"\n            ;;\n        azure)\n            echo "  Azure VM Security:"\n            echo "  • Update Network Security Group to allow port $SYSTEMMANAGER_PORT"\n            echo "  • Or use Tailscale for secure access (recommended)"\n            echo ""\n            echo "  NSG rule:"\n            echo "    Priority: 1000"\n            echo "    Port: $SYSTEMMANAGER_PORT"\n            echo "    Protocol: TCP"\n            echo "    Source: Any (if using Tailscale)"\n            ;;\n        digitalocean)\n            echo "  DigitalOcean Droplet Security:"\n            echo "  • Update Firewall to allow port $SYSTEMMANAGER_PORT"\n            echo "  • Or use Tailscale for secure access (recommended)"\n            ;;\n        *)\n            echo "  Generic Cloud Security:"\n            echo "  • Ensure firewall allows port $SYSTEMMANAGER_PORT"\n            echo "  • Use Tailscale for secure access (strongly recommended)"\n            echo "  • Never expose without authentication!"\n            ;;\n    esac\n\n    echo ""\n    echo -e "${GREEN}  Recommended: Use Tailscale${NC}"\n    echo "    Tailscale provides encrypted, authenticated access"\n    echo "    without exposing ports to the internet."\n    echo "    Install: curl -fsSL https://tailscale.com/install.sh | sh"\n    echo ""\n    print_separator\n}\n\n#######################################\n# Cloud Instance Metadata\n#######################################\n\nfunction detect_cloud_metadata() {\n    msg_info "Detecting cloud instance metadata"\n\n    case "$CLOUD_PROVIDER" in\n        aws)\n            get_aws_metadata\n            ;;\n        gcp)\n            get_gcp_metadata\n            ;;\n        azure)\n            get_azure_metadata\n            ;;\n    esac\n}\n\nfunction get_aws_metadata() {\n    # Try to get instance ID\n    INSTANCE_ID=$(curl -sf -m 2 http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null || echo "unknown")\n    INSTANCE_TYPE=$(curl -sf -m 2 http://169.254.169.254/latest/meta-data/instance-type 2>/dev/null || echo "unknown")\n    REGION=$(curl -sf -m 2 http://169.254.169.254/latest/meta-data/placement/region 2>/dev/null || echo "unknown")\n\n    if [ "$INSTANCE_ID" != "unknown" ]; then\n        msg_info "AWS Instance ID: $INSTANCE_ID"\n        msg_info "Instance Type: $INSTANCE_TYPE"\n        msg_info "Region: $REGION"\n\n        export INSTANCE_ID INSTANCE_TYPE REGION\n    fi\n}\n\nfunction get_gcp_metadata() {\n    INSTANCE_ID=$(curl -sf -H "Metadata-Flavor: Google" -m 2 \\n        http://metadata.google.internal/computeMetadata/v1/instance/id 2>/dev/null || echo "unknown")\n    INSTANCE_NAME=$(curl -sf -H "Metadata-Flavor: Google" -m 2 \\n        http://metadata.google.internal/computeMetadata/v1/instance/name 2>/dev/null || echo "unknown")\n\n    if [ "$INSTANCE_ID" != "unknown" ]; then\n        msg_info "GCP Instance: $INSTANCE_NAME ($INSTANCE_ID)"\n        export INSTANCE_ID INSTANCE_NAME\n    fi\n}\n\nfunction get_azure_metadata() {\n    local metadata=$(curl -sf -H "Metadata:true" -m 2 \\n        "http://169.254.169.254/metadata/instance?api-version=2021-02-01" 2>/dev/null)\n\n    if [ -n "$metadata" ]; then\n        msg_info "Azure VM metadata retrieved"\n    fi\n}\n\n#######################################\n# Main Cloud Installation\n#######################################\n\n# Detect script directory\nSCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"\n\n# Source the standalone installer\nif [ -f "$SCRIPT_DIR/install-standalone.sh" ]; then\n    # Just source functions, don't run main\n    source "$SCRIPT_DIR/install-standalone.sh" --help >/dev/null 2>&1 || true\n\n    # Load libraries manually\n    load_libraries\n\n    # Run cloud-specific installation\n    print_banner\n    init_state\n    setup_error_handling\n\n    # Load config if provided\n    load_config_file\n\n    # Platform detection\n    run_platform_detection\n\n    # Cloud metadata detection\n    detect_cloud_metadata\n\n    # Run pre-flight checks\n    run_preflight_checks || exit 1\n\n    # Check for upgrade mode\n    if [ "$UPGRADE_MODE" = "true" ]; then\n        perform_upgrade\n        display_installation_summary "$SYSTEMMANAGER_PORT"\n        display_cloud_security_notes\n        cleanup_state\n        exit 0\n    fi\n\n    # Fresh installation\n    print_separator\n    msg_info "Starting TailOpsMCP installation (Cloud Environment: $CLOUD_PROVIDER)"\n    print_separator\n\n    # Install dependencies\n    install_dependencies\n\n    # Setup installation\n    setup_installation_directory\n    setup_python_environment\n    setup_service_user\n\n    # Configure authentication\n    configure_authentication || exit 1\n\n    # Setup and start service\n    setup_systemd_service\n    start_systemmanager_service\n\n    # Apply cloud optimizations\n    apply_cloud_optimizations\n    configure_cloud_security\n\n    # Validate installation\n    print_separator\n    if run_post_install_validation; then\n        # Display success summary\n        display_installation_summary "$SYSTEMMANAGER_PORT"\n        display_cloud_security_notes\n\n        cleanup_state\n        exit 0\n    else\n        msg_error "Installation validation failed"\n        msg_info "Check logs: journalctl -u systemmanager-mcp -n 100"\n        exit 1\n    fi\nelse\n    echo "ERROR: install-standalone.sh not found in $SCRIPT_DIR"\n    exit 1\nfi\n
